rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

                                        // Helper function to check if user is authenticated
function isAuthenticated() {
return request.auth != null;
}

// Helper function to check if user owns the document
function isOwner(userId) {
return isAuthenticated() && request.auth.uid == userId;
}

// Users collection - users can read/write their own data
match /users/{userId} {
allow read: if isAuthenticated();
allow write: if isOwner(userId);
}

// Galleries collection
match /galleries/{galleryId} {
// Anyone can read galleries (for public showcase feature)
allow read: if true;

// Only authenticated users can create galleries
allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

// Only owner can update or delete their galleries
allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
}

// Folders collection (for documents)
match /folders/{folderId} {
// Anyone can read folders (for public showcase feature)
allow read: if true;

// Only authenticated users can create folders
allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

// Only owner can update or delete their folders
allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
}

// Documents collection (individual document files)
match /documents/{documentId} {
// Anyone can read documents (for public showcase feature)
allow read: if true;

// Only authenticated users can create documents
allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

// Only owner can update or delete their documents
allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
}

// Tags collection
match /tags/{tagId} {
// Anyone can read tags
allow read: if true;

// Only authenticated users can create tags
allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

// Only owner can update or delete their tags
allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
}

// Bookmarks collection
match /bookmarks/{bookmarkId} {
// Users can only read their own bookmarks
allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

// Users can create their own bookmarks
allow create: if isAuthenticated() &&
  request.resource.data.userId == request.auth.uid &&
  request.resource.data.ownerUserId != null;

// Users can delete their own bookmarks OR the owner of the bookmarked item can delete
// (needed when unpinning showcase galleries/folders to remove all bookmarks)
allow delete: if isAuthenticated() &&
  (resource.data.userId == request.auth.uid ||
   (resource.data.keys().hasAll(['ownerUserId']) && resource.data.ownerUserId == request.auth.uid));
}
}
}
